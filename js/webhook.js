

document.addEventListener("DOMContentLoaded", function () {
  let cityName = "Ëá∫‰∏≠Â∏Ç";
  const paths = document.querySelectorAll(".map path");

  // Weather
  const weatherImage = document.querySelector("#wx-img");

  weatherImage.addEventListener("click", function (e) {
    console.log("‰ª•ÈªûÊìä");
    sendDataToZapier(cityName);
  });

  const aqiIcon = document.getElementById("aqiIcon");

  aqiIcon.addEventListener("click", function (e) {
    sendAirToZapier(cityName, selectedOption);
  });

  // Air
  const selectElement = document.querySelector("#sitenameSelect");
  let selectedOption;
  selectElement.addEventListener("change", function() {
      selectedOption = selectElement.value;
  });

  // Sun

  const sunRiseTime = document.querySelector("#sunRiseTime");
  const sunSetTime = document.querySelector("#sunSetTime");

  const sunRiseImg = document.querySelector(".sunrise");
  const sunSetImg = document.querySelector(".sunset");

  console.log("sunRiseImg:", sunRiseImg);

  sunRiseImg.addEventListener("click", function (e) {
    sendSunToZapier(cityName, sunRiseTime, sunSetTime, true );
  });
  sunSetImg.addEventListener("click", function (e) {
    sendSunToZapier(cityName, sunRiseTime, sunSetTime, false );
  });

  paths.forEach(path => {
    path.addEventListener("click", function (e) {
      cityName = e.currentTarget.getAttribute("data-name");
    });
  });
});

function timeCatch(night){

  const year = document.querySelector("#year").textContent;
  const monthDay = document.querySelector("#monthDay").textContent;
  const weekDay = document.querySelector("#weekDay").textContent;

  const monthMap = {
    "Jan": "1",
    "Feb": "2",
    "Mar": "3",
    "Apr": "4",
    "May": "5",
    "Jun": "6",
    "Jul": "7",
    "Aug": "8",
    "Sep": "9",
    "Oct": "10",
    "Nov": "11",
    "Dec": "12"
  };

  const regexMonthDay = /^([A-Za-z]+)\.(\d+)/;

  const dateParts = monthDay.match(regexMonthDay);

  // const dateText = document.querySelector("#date").textContent;
  // const removedPrefix = dateText.replace("Êó•ÊúüÔºö", "").trim();
  // const dateParts = removedPrefix.split("-");
  // const year = dateParts[0];
  const monthWord = dateParts[1];
  const day = dateParts[2];

  const month = monthMap[monthWord];

  // Date
  const newDateStr = `${month}/${day}, ${year}`;

  const now = new Date();
  const hours = now.getHours();
  const minutes = now.getMinutes();
  const period = hours >= 12 ? "‰∏ãÂçà" : "‰∏äÂçà";
  const currentHour = hours % 12 === 0 ? 12 : hours % 12;  // Â∞á 24 Â∞èÊôÇÂà∂ËΩâÊèõÁÇ∫ 12 Â∞èÊôÇÂà∂
  if(hours >= 18 || hours < 6) {
    night = true;
  }
  // Time
  const currentTime = `${period} ${currentHour < 10 ? "0" : " "}${currentHour}:${minutes < 10 ? "0" : ""}${minutes}`;

  return {
    newDateStr,
    currentTime,
    night
  };
}

async function sendDataToZapier(county) {
  const zapierWebhookURL = "https://hooks.zapier.com/hooks/catch/15050980/3sjsmi4/";

  // County
  // const county = document.querySelector("#county").textContent;

  let night = false;
  const result = timeCatch(night);
  const newDateStr = result.newDateStr;
  const currentTime = result.currentTime;
  night = result.night;

  let imgUrl, iconUrl, welcome;
  if(night){
    imgUrl = "https://i.imgur.com/C67obDr.png"
    iconUrl = "https://i.imgur.com/C67obDr.png";
    welcome = "ÊôöÂÆâ üåõÔºå";
  } else {
    imgUrl = "https://i.imgur.com/YsdUgwS.jpg"
    iconUrl = "https://i.imgur.com/JkkfA8i.png";
    welcome = "ÂÆâÂÆâ üåûÔºå";
  }

  // Wx image
  const wx = document.querySelector("#Wx");
  const weatherImage =document.querySelector("#wx-img");

  // Wx
  const wxContent = wx.textContent;
  const wxStr = wxContent.replace("Â§©Ê∞£ÁèæË±°Ôºö", "").trim();
  console.log("wxStr:", wxStr);

  // T
  const temperature = document.querySelector("#T").textContent;
  const temperatureStr = temperature.replace("Ê∫´Â∫¶Ôºö", "").trim();

  // Ws
  const windSpeed = document.querySelector("#Ws").textContent;
  const windSpeedStr = windSpeed.replace("È¢®ÈÄüÔºö", "").trim();

  // PoP6h
  const rainFall6h = document.querySelector("#PoP6h").textContent;
  const rainFall6hStr = rainFall6h.replace("6Â∞èÊôÇÈôçÈõ®Ê©üÁéáÔºö", "").trim();

  // weather-one
  const weatherOne = document.querySelector("#weatherData1");
  const weatherOneTime = weatherOne.querySelector("#timeDescribe").textContent;
  const weatherOneTimeStr = weatherOneTime.replace("Êó•ÊúüÊèèËø∞Ôºö", "").trim();
  const weatherOneWeather = weatherOne.querySelector("#Wx").textContent;
  const weatherOneWeatherStr = weatherOneWeather.replace("Â§©Ê∞£ÁèæË±°Ôºö", "").trim();

  const weatherOneTemperature = weatherOne.querySelector("#T").textContent;
  const weatherOneTemperatureStr = weatherOneTemperature.replace("Ê∫´Â∫¶Ôºö", "").trim();
  // const weatherOneWindSpeed = weatherOne.querySelector("#Ws").textContent;
  // const weatherOneWindSpeedStr = weatherOneWindSpeed.replace("È¢®ÈÄüÔºö", "").trim();
  const weatherOneRainFall = weatherOne.querySelector("#PoP12h").textContent;
  const weatherOneRainFallStr = weatherOneRainFall.replace("ÈôçÈõ®Ê©üÁéáÔºö", "").trim();

  //weatherTwo 
  const weatherTwo = document.querySelector("#weatherData2");
  const weatherTwoTime = weatherTwo.querySelector("#timeDescribe").textContent;
  const weatherTwoTimeStr = weatherTwoTime.replace("Êó•ÊúüÊèèËø∞Ôºö", "").trim();
  const weatherTwoWeather = weatherTwo.querySelector("#Wx").textContent;
  const weatherTwoWeatherStr = weatherTwoWeather.replace("Â§©Ê∞£ÁèæË±°Ôºö", "").trim();
  const weatherTwoTemperature = weatherTwo.querySelector("#T").textContent;
  const weatherTwoTemperatureStr = weatherTwoTemperature.replace("Ê∫´Â∫¶Ôºö", "").trim();
  // const weatherTwoWindSpeed = weatherTwo.querySelector("#Ws").textContent;
  // const weatherTwoWindSpeedStr = weatherTwoWindSpeed.replace("È¢®ÈÄüÔºö", "").trim();
  const weatherTwoRainFall = weatherTwo.querySelector("#PoP12h").textContent;
  const weatherTwoRainFallStr = weatherTwoRainFall.replace("ÈôçÈõ®Ê©üÁéáÔºö", "").trim();

  //weatherThree
  const weatherThree = document.querySelector("#weatherData3");
  const weatherThreeTime = weatherThree.querySelector("#timeDescribe").textContent;
  const weatherThreeTimeStr = weatherThreeTime.replace("Êó•ÊúüÊèèËø∞Ôºö", "").trim();
  const weatherThreeWeather = weatherThree.querySelector("#Wx").textContent;
  const weatherThreeWeatherStr = weatherThreeWeather.replace("Â§©Ê∞£ÁèæË±°Ôºö", "").trim();
  const weatherThreeTemperature = weatherThree.querySelector("#T").textContent;
  const weatherThreeTemperatureStr = weatherThreeTemperature.replace("Ê∫´Â∫¶Ôºö", "").trim();
  // const weatherThreeWindSpeed = weatherThree.querySelector("#Ws").textContent;
  // const weatherThreeWindSpeedStr = weatherThreeWindSpeed.replace("È¢®ÈÄüÔºö", "").trim();
  const weatherThreeRainFall = weatherThree.querySelector("#PoP12h").textContent;
  const weatherThreeRainFallStr = weatherThreeRainFall.replace("ÈôçÈõ®Ê©üÁéáÔºö", "").trim();

  const payload = {
    "content": `${newDateStr} ${currentTime}Ôºå${county}ÁöÑÂ§©Ê∞£Â¶Ç‰∏ã`,
    "username": "Â§©Á©∫ÁîüÊ∞£‰∫∫",
    "avatar_url": `${imgUrl}`,
    "embeds": [
      {
        "author": {
          "name": "The Sky goes nuts",
          "icon_url": `${iconUrl}`
        },
        "title": "Â§©Á©∫ÁîüÊ∞£Ê∞£Â†±Âëä",
        "description": `${welcome}, Â§©Ê∞£ÈÇÑÂ•ΩÂóéÔºü`,
        "color": 16426522,
        "fields": [
          {
            "name": "‚òÅÔ∏èÂ§©Ê∞£",
            "value": `${wxStr}`,
            "inline": true
          },
          {
            "name": "üå°Ô∏è Ê∫´Â∫¶",
            "value": `${temperatureStr}`,
            "inline": true
          },
          {
            "name": "üå¨È¢®ÈÄü",
            "value": `${windSpeedStr}`,
            "inline": true
          },
          {
            "name": "üåßÔ∏è ÈôçÈõ®Áéá(6h)",
            "value": `${rainFall6hStr}`,
            "inline": true
          },
          {
            "name": `${weatherOneTimeStr}`,
            "value": `${weatherOneWeatherStr}, üå°Ô∏è ${weatherOneTemperatureStr}, üåßÔ∏è ${weatherOneRainFallStr}(12h)`
          },
          {
            "name": `${weatherTwoTimeStr}`,
            "value": `${weatherTwoWeatherStr}, üå°Ô∏è ${weatherTwoTemperatureStr}, üåßÔ∏è ${weatherTwoRainFallStr}(12h)`
          },
          {
            "name": `${weatherThreeTimeStr}`,
            "value": `${weatherThreeWeatherStr}, üå°Ô∏è ${weatherThreeTemperatureStr}, üåßÔ∏è ${weatherThreeRainFallStr}(12h)`
          }
        ],
        "footer": {
          "text": "üëÜ Ë´ãÊ≥®ÊÑè‰ª•‰∏äÂ§©Ê∞£ËÆäÂåñ, special thanks to [PastLeo](https://pastleo.me/)"
        },
        "image": {
          "url": `https://i.imgur.com/7Clp18f.jpg`
        }
      }
    ]
  };

  console.log("payload:", payload);

  // ÁôºÈÄÅË®äÊÅØ
    await fetch(zapierWebhookURL, {
      method: "POST",
      headers: {
        // "Content-Type": "application/json",
      },
      body: JSON.stringify(payload),
    })
    .then(response => response.json())
    .then(data => {
      console.log("Â§©Ê∞£Ë®äÊÅØÁôºÈÄÅÊàêÂäü:", data);
    })
    .catch((error) => {
      console.log("Â§©Ê∞£Ë®äÊÅØÁôºÈÄÅÂ§±Êïó:", error);
    });
};


async function sendAirToZapier(cityName, selectedOption){
  const zapierWebhookURL = "https://hooks.zapier.com/hooks/catch/15050980/3sjsmi4/";

  let night = false;
  const result = timeCatch(night);
  const newDateStr = result.newDateStr;
  const currentTime = result.currentTime;
  night = result.night;

  // let imgUrl, iconUrl;
  // if(night){
  //   imgUrl = "https://i.imgur.com/C67obDr.png"
  //   iconUrl = "https://i.imgur.com/C67obDr.png";
  // } else {
  //   imgUrl = "https://i.imgur.com/YsdUgwS.jpg"
  //   iconUrl = "https://i.imgur.com/JkkfA8i.png";
  // }

  let imgUrl = "https://i.imgur.com/iZ90pFJ.jpg"
  let iconUrl = "https://i.imgur.com/iZ90pFJ.jpg";


  const aqi = document.querySelector("#aqi").textContent;
  const status = document.querySelector("#aqiStatus").textContent;
  const pollutant = document.querySelector("#pollutant").textContent;

  let caution, allergicCaution;

  if (status === "ËâØÂ•Ω") {
     caution =  "Ê≠£Â∏∏Êà∂Â§ñÊ¥ªÂãï";
     allergicCaution = "Ê≠£Â∏∏Êà∂Â§ñÊ¥ªÂãï";
  } else if (status === "ÊôÆÈÄö") {
    caution = "Ê≠£Â∏∏Êà∂Â§ñÊ¥ªÂãï";
    allergicCaution = "Ê≥®ÊÑèÂí≥ÂóΩÊàñÂëºÂê∏ÊÄ•‰øÉ";
  } else if (status === "Â∞çÊïèÊÑüÊóèÁæ§‰∏çÂÅ•Â∫∑") {
    caution = "Âª∫Ë≠∞Ê∏õÂ∞ëÈï∑ÊôÇÈñìÂäáÁÉàÈÅãÂãï";
    allergicCaution = "Âª∫Ë≠∞Ê∏õÂ∞ëÊà∂Â§ñÊ¥ªÂãïÂèäÈ´îÂäõÊ∂àËÄó";
  } else if (status === "Â∞çÊâÄÊúâÊóèÁæ§‰∏çÂÅ•Â∫∑") {
    caution = "Ê∏õÂ∞ëÊà∂Â§ñÊ¥ªÂãï";
    allergicCaution = "Âª∫Ë≠∞ÁïôÂú®ÂÆ§ÂÖß‰∏¶Ê∏õÂ∞ëÈ´îÂäõÊ∂àËÄó"; 
  } else if (status === "ÈùûÂ∏∏‰∏çÂÅ•Â∫∑") {
     caution = "Ê∏õÂ∞ëÊàñÂÅúÊ≠¢Êà∂Â§ñÊ¥ªÂãï";
    allergicCaution = "ÂøÖÈ†àÁïôÂú®ÂÆ§ÂÖß‰∏¶Ê∏õÂ∞ëÈ´îÂäõÊ∂àËÄó";
  } else if (status === "Âç±ÂÆ≥") {
    caution = "ÂÅúÊ≠¢Êà∂Â§ñÊ¥ªÂãï„ÄÅÈóúÁ∑äÈñÄÁ™ó";
    allergicCaution = "ÂøÖÈ†àÁïôÂú®ÂÆ§ÂÖß‰∏¶Ê∏õÂ∞ëÈ´îÂäõÊ∂àËÄó";
  } 


  const payload = {
    "content": `${newDateStr} ${currentTime}Ôºå${cityName} ${selectedOption} ËßÄÊ∏¨Á´ôÁöÑÁ©∫Ê∞£ÂìÅË≥™Â¶Ç‰∏ã`,
    "username": "Á©∫Ê∞£Ëá≠‰∏çËá≠",
    "avatar_url": `${imgUrl}`,
    "embeds": [
      {
        "author": {
          "name": "The Air cuts the cheese",
          "icon_url": `${iconUrl}`
        },
        "title": "Á©∫Ê∞£Ëá≠‰∏çËá≠ÂÅµ‰ø°Á§æ",
        "description": "Á©∫Ê∞£ÈÇÑÂ•ΩÂóéÔºü",
        "color": 4437377,
        "fields": [
          {
            "name": "üî¢ Á©∫Ê∞£ÂìÅË≥™ÊåáÊ®ô(AQI)",
            "value": `${aqi}`,
            "inline": true
          },
          {
            "name": "üè≠Ê±°ÊüìÁâ©",
            "value": `${pollutant}`,
            "inline": true
          },
          {
            "name": "‚ùìÁ©∫Ê∞£ÂìÅË≥™",
            "value": `${status}`,
            "inline": true
          },
          {
            "name": "üòä ‰∏ÄËà¨‰∫∫ÁöÑÂÅ•Â∫∑Âª∫Ë≠∞",
            "value": `${caution}`
          },
          {
            "name": "üò£ ÊïèÊÑüÊóèÁæ§ÂÅ•Â∫∑Âª∫Ë≠∞",
            "value": `${allergicCaution}`
          },
        ],
        "footer": {
          "text": `üëÜ Ë´ãÂ∞§ÂÖ∂Ê≥®ÊÑè‰ª•‰∏äÊ¥ªÂãïÂª∫Ë≠∞`
        },
        "image": {
          "url": `https://i.imgur.com/4EUmVCg.png`
        }
      }
    ]
  };

  console.log("payload:", payload);

  await fetch(zapierWebhookURL, {
    method: "POST",
    headers: {
      // "Content-Type": "application/json",
    },
    body: JSON.stringify(payload),
  })
  .then(response => response.json())
  .then(data => {
    console.log("Á©∫Ê∞£Ë®äÊÅØÁôºÈÄÅÊàêÂäü:", data);
  })
  .catch((error) => {
    console.log("Á©∫Ê∞£Ë®äÊÅØÁôºÈÄÅÂ§±Êïó:", error);
  });
}

async function sendSunToZapier(cityName, sunRiseTime, sunSetTime, sunRise){

  const zapierWebhookURL = "https://hooks.zapier.com/hooks/catch/15050980/3sjsmi4/";

  const result = timeCatch();
  const newDateStr = result.newDateStr;
  const currentTime = result.currentTime;

  const sunRiseTimeStr = sunRiseTime.textContent.replace( "Êó•Âá∫", "").trim();
  const sunSetTimeStr = sunSetTime.textContent.replace( "Êó•ËêΩ", "").trim();


  let mainImgUrl, keyword, avatarUrl ="";
  if (sunRise) {
    mainImgUrl = "https://www.gomaji.com/blog/wp-content/uploads/2021/06/%E9%A6%96%E5%9C%96_%E9%9A%99%E9%A0%82%E4%BA%8C%E5%BB%B6%E5%B9%B3%E6%AD%A5%E9%81%93_ooxx2081.jpg";
    keyword = "Âá∫";
    avatarUrl ="https://i.imgur.com/UkkOa1y.jpg";
  } else {
    mainImgUrl = "https://www.winnews.com.tw/wp-content/uploads/2020/03/%E6%B7%A1%E6%B0%B4%E6%B2%99%E5%B4%99%E4%B8%96%E7%95%8C%E5%8D%81%E5%A4%A7%E5%A4%95%E9%99%BD-scaled.jpg";
    keyword = "ËêΩ";
    avatarUrl ="https://i.imgur.com/7qwB1oy.jpg";
  }

  const payload = {
    "content": `${newDateStr} ${currentTime}Ôºå${cityName} ‰ªäÂ§©ÁöÑÊó•${keyword}ÊôÇÈñìÁÇ∫`,
    "username": "Êµ™Êº´ na Ê©üÂô®‰∫∫",
    "avatar_url": `${avatarUrl}`,
    "embeds": [
      {
        "author": {
          "name": `Always look at the sun${keyword == "Âá∫" ? "rise üåÑ " : "set üåá "}; I will be there`,
          "icon_url": "https://i.imgur.com/JkkfA8i.png"
        },
        "title": `Êó•${keyword}ÁçµÊâã`,
        "description": `ÊÉ≥ÁúãÊó•${keyword}ÂóéÔºü`,
        "color": 15746887,
        "fields": [
          {
            "name": `Êó•${keyword == "Âá∫" ? "Âá∫ üåÑ " : "ËêΩ üåá "}ÊôÇÈñì`,
            "value": `${keyword == "Âá∫" ? sunRiseTimeStr : sunSetTimeStr}`,
            "inline": true
          },
          {
            "name": `Êó•${keyword == "ËêΩ" ? "Âá∫ üåÑ " : "ËêΩ üåá "}ÊôÇÈñì`,
            "value": `${keyword == "ËêΩ" ? sunRiseTimeStr : sunSetTimeStr}`,
            "inline": true
          },
          {
            "name": "üåπÊµ™Êº´Â∞èË™û",
            "value": `${keyword == "Âá∫" ? "Áï¢Á´üÔºåÊó•Âá∫Á∏ΩÊòØÊªøÊá∑Â∏åÊúõ" : "ÊØè‰∏ÄÊ¨°Â§ïÈôΩÁ∏ΩÁ∏ΩËàáÁúæ‰∏çÂêå„ÄÇ"}`
          }
        ],
        "footer": {
          "text": `üëÜ Ë´ã‰∫´ÂèóÁæéÈ∫óÁöÑÊó•${keyword}`
        },
        "image": {
          "url": `${mainImgUrl}`
        }
      }
    ]
  };
  console.log("payload:", payload);

  await fetch(zapierWebhookURL, {
    method: "POST",
    headers: {
      // "Content-Type": "application/json",
    },
    body: JSON.stringify(payload),
  })
  .then(response => response.json())
  .then(data => {
    console.log("Êó•Âá∫Êó•ËêΩË®äÊÅØÁôºÈÄÅÊàêÂäü:", data);
  })
  .catch((error) => {
    console.log("Êó•Âá∫Êó•ËêΩË®äÊÅØÁôºÈÄÅÂ§±Êïó:", error);
  });
  
}

function convertTo12HourTime(time) {
  const [hours, minutes] = time.split(":");
  
  // Â∞áÂ∞èÊôÇÈÉ®ÂàÜËΩâÊèõÁÇ∫Êï∏Â≠ó
  const hour = parseInt(hours, 10);
  
  // Âà§Êñ∑ÊôÇÈñìÊòØ‰∏äÂçàÈÇÑÊòØ‰∏ãÂçà
  let period;
  if (hour < 1) {
      period = "ÂçàÂ§ú";
  } else if (hour < 6) {
      period = "ÂáåÊô®";
  } else if(hour < 8) {
      period = "Ê∏ÖÊô®";
  } else if (hour < 12) {
      period = "‰∏äÂçà";
  } else if (hour < 13) {
      period = "‰∏≠Âçà";
  } else if (hour < 18) {
      period = "‰∏ãÂçà";
  } else if (hour < 23) {
      period = "Êôö‰∏ä";
  } else if (hour < 24) {
      period = "ÂçàÂ§ú";
  }
  
  const hour12 = hour % 12 === 0 ? 12 : hour % 12;
  
  const formattedTime = `${period} ${hour12}:${minutes}`;
  
  return formattedTime;
}



